#!/usr/bin/env bash
set -euo pipefail

REMOTE="$1"
URL="$2"

# determine current branch
current_branch="$(git rev-parse --abbrev-ref HEAD)"

if [[ "$current_branch" != "main" && "$current_branch" != "master" ]]; then
  # allow push on other branches
  exit 0
fi

# ensure origin exists and fetch latest refs
git remote get-url origin >/dev/null 2>&1 || { echo "Remote 'origin' not found."; exit 1; }
git fetch origin --quiet

# find the remote's branch ref (origin/main or origin/master)
remote_branch_ref=""
if git show-ref --verify --quiet "refs/remotes/origin/$current_branch"; then
  remote_branch_ref="refs/remotes/origin/$current_branch"
else
  # remote branch doesn't exist yet â€” treat as changed (allow push)
  exit 0
fi

# find the list of commits we're about to push
# local tip and remote tip
local_tip="$(git rev-parse "$current_branch")"
remote_tip="$(git rev-parse "$remote_branch_ref")"

# if identical, nothing to push
if [[ "$local_tip" == "$remote_tip" ]]; then
  exit 0
fi

# get list of files changed between remote_tip and local_tip (only commits being pushed)
changed_files="$(git diff --name-only "$remote_tip" "$local_tip")"

# if VERSION file was modified among those changes, allow push
if echo "$changed_files" | grep -xq "VERSION"; then
  exit 0
fi

# At this point: pushing to main and VERSION was NOT modified. Block push.
if [[ ! -f VERSION ]]; then
  echo "VERSION file not found at repo root. Aborting push."
  exit 1
fi

# read current semver
current_version="$(tr -d ' \t\n\r' < VERSION || true)"
if [[ -z "$current_version" ]]; then
  echo "VERSION file is empty. Aborting push."
  exit 1
fi

# parse semver (MAJOR.MINOR.PATCH), allow optional pre-release/build ignored
if [[ "$current_version" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(.*)$ ]]; then
  major="${BASH_REMATCH[1]}"
  minor="${BASH_REMATCH[2]}"
  patch="${BASH_REMATCH[3]}"
  suffix="${BASH_REMATCH[4]}"
else
  echo "VERSION does not match MAJOR.MINOR.PATCH format: '$current_version'. Aborting push."
  exit 1
fi

# increment patch
new_patch=$((patch + 1))
new_version="${major}.${minor}.${new_patch}${suffix}"

# write new VERSION
printf "%s\n" "$new_version" > VERSION

# stage the change
git add VERSION

# instruct user to commit and push
cat <<EOF

Push blocked: you attempted to push to '$current_branch' without updating VERSION.
VERSION was automatically bumped:
  $current_version -> $new_version

The new VERSION file has been staged. Please run:

  git commit -m "Bump VERSION to $new_version"
  git push

(If you want to change versioning behavior, modify .git/hooks/pre-push.)

EOF

# prevent the push
exit 1
