#!/usr/bin/env bash

# Runs on pushes to main branch: ensures VERSION follows MAJOR.MINOR.PATCH and is strictly incremented. 
#   If pushed commits change VERSION, rejects the push unless the new VERSION > remote VERSION. 
#   If VERSION wasn't updated, auto-bumps the patch, stages the file, blocks the push, and prompts the user to commit and push the new VERSION. 

set -euo pipefail

REMOTE="$1"
URL="$2"

# determine current branch
current_branch="$(git rev-parse --abbrev-ref HEAD)"

if [[ "$current_branch" != "main" && "$current_branch" != "master" ]]; then
  exit 0
fi

git remote get-url origin >/dev/null 2>&1 || { echo "Remote 'origin' not found."; exit 1; }
git fetch origin --quiet

# if remote branch doesn't exist yet, allow push (new branch)
if ! git show-ref --verify --quiet "refs/remotes/origin/$current_branch"; then
  exit 0
fi

local_tip="$(git rev-parse "$current_branch")"
remote_tip="$(git rev-parse "refs/remotes/origin/$current_branch")"

if [[ "$local_tip" == "$remote_tip" ]]; then
  exit 0
fi

changed_files="$(git diff --name-only "$remote_tip" "$local_tip")"

# helper: parse semver (returns major minor patch)
parse_semver() {
  local v="$1"
  if [[ "$v" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)($|[^0-9].*) ]]; then
    echo "${BASH_REMATCH[1]} ${BASH_REMATCH[2]} ${BASH_REMATCH[3]}"
    return 0
  fi
  return 1
}

# helper: compare semver; returns 0 if a > b, 1 otherwise
semver_gt() {
  read -r a_major a_minor a_patch <<<"$(parse_semver "$1")" || return 1
  read -r b_major b_minor b_patch <<<"$(parse_semver "$2")" || return 1
  if (( a_major > b_major )); then return 0; fi
  if (( a_major < b_major )); then return 1; fi
  if (( a_minor > b_minor )); then return 0; fi
  if (( a_minor < b_minor )); then return 1; fi
  if (( a_patch > b_patch )); then return 0; fi
  return 1
}

# read remote VERSION (from remote_tip)
remote_version=""
if git cat-file -e "$remote_tip:VERSION" 2>/dev/null; then
  remote_version="$(git show "$remote_tip:VERSION" | tr -d ' \t\n\r')"
else
  # no remote VERSION -> allow push (treat as initial)
  remote_version=""
fi

# read local (to-be-pushed) VERSION (from local_tip)
local_version=""
if git cat-file -e "$local_tip:VERSION" 2>/dev/null; then
  local_version="$(git show "$local_tip:VERSION" | tr -d ' \t\n\r')"
else
  local_version=""
fi

# If VERSION was modified in the push:
if echo "$changed_files" | grep -xq "VERSION"; then
  # Ensure both versions exist and local_version > remote_version
  if [[ -z "$remote_version" ]]; then
    # remote has no VERSION, allow if local has a valid semver
    if ! parse_semver "$local_version" >/dev/null 2>&1; then
      echo "Invalid VERSION in pushed commits: '$local_version'. Aborting push."
      exit 1
    fi
    exit 0
  fi

  if ! parse_semver "$remote_version" >/dev/null 2>&1; then
    echo "Remote VERSION invalid: '$remote_version'. Aborting push."
    exit 1
  fi
  if ! parse_semver "$local_version" >/dev/null 2>&1; then
    echo "Local VERSION invalid: '$local_version'. Aborting push."
    exit 1
  fi

  if semver_gt "$local_version" "$remote_version"; then
    exit 0
  else
    echo "Push blocked: pushed VERSION ($local_version) is not greater than remote VERSION ($remote_version)."
    echo "Please increment VERSION (MAJOR.MINOR.PATCH) and try again."
    exit 1
  fi
fi

# VERSION was NOT modified in the push -> auto-bump patch locally and stage
if [[ ! -f VERSION ]]; then
  echo "VERSION file not found at repo root. Aborting push."
  exit 1
fi

current_version="$(tr -d ' \t\n\r' < VERSION || true)"
if [[ -z "$current_version" ]]; then
  echo "VERSION file is empty. Aborting push."
  exit 1
fi

if ! parse_semver "$current_version" >/dev/null 2>&1; then
  echo "VERSION does not match MAJOR.MINOR.PATCH: '$current_version'. Aborting push."
  exit 1
fi

read -r major minor patch <<<"$(parse_semver "$current_version")"
new_patch=$((patch + 1))
new_version="${major}.${minor}.${new_patch}"

# Ensure new_version is greater than remote_version (if remote exists)
if [[ -n "$remote_version" ]]; then
  if ! semver_gt "$new_version" "$remote_version"; then
    # if equal or not greater (shouldn't happen), bump until greater
    while ! semver_gt "$new_version" "$remote_version"; do
      new_patch=$((new_patch + 1))
      new_version="${major}.${minor}.${new_patch}"
    done
  fi
fi

printf "%s\n" "$new_version" > VERSION
git add VERSION

cat <<EOF

Push blocked: you attempted to push to '$current_branch' without updating VERSION.
VERSION was automatically bumped:
  $current_version -> $new_version

The new VERSION file has been staged. Please run:

  git commit -m "Bump VERSION to $new_version"
  git push

EOF

exit 1
