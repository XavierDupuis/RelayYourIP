#!/usr/bin/env bash
set -euo pipefail

REMOTE="$1"
URL="$2"

# Only run when local branch is main
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [[ "$current_branch" != "main" ]]; then
  exit 0
fi

# Read first line from stdin (pre-push provides refs lines); handle multiple lines but consider first matching refs/heads/main
pushed_any=false
while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ "$local_ref" =~ ^refs/heads/main$ ]]; then
    pushed_any=true
    push_local_sha="$local_sha"
    push_remote_sha="$remote_sha"
    break
  fi
done

# If nothing to push for main, exit
if [[ "$pushed_any" != true ]]; then
  exit 0
fi

VERSION_FILE="VERSION"
if [[ ! -f "$VERSION_FILE" ]]; then
  exit 0
fi

# Determine changed files in the push range
if [[ "$push_remote_sha" == "0000000000000000000000000000000000000000" ]]; then
  # new branch on remote: check changes in the local ref
  changed_files=$(git diff --name-only "${push_local_sha}^" "$push_local_sha" 2>/dev/null || git ls-tree -r --name-only "$push_local_sha")
else
  changed_files=$(git diff --name-only "$push_remote_sha" "$push_local_sha" 2>/dev/null || true)
fi

if echo "$changed_files" | grep -qx "$VERSION_FILE"; then
  # VERSION was modified in the pushed commits â€” allow push
  exit 0
fi

# Read current version
current_version=$(sed -n '1s/^[[:space:]]*//;s/[[:space:]]*$//;p' "$VERSION_FILE")
if [[ -z "$current_version" ]]; then
  echo "VERSION is empty; aborting push." >&2
  exit 1
fi

if ! [[ "$current_version" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)([-+].*)?$ ]]; then
  echo "VERSION ('$current_version') is not a valid semver MAJOR.MINOR.PATCH; aborting." >&2
  exit 1
fi

major=${BASH_REMATCH[1]}
minor=${BASH_REMATCH[2]}
patch=${BASH_REMATCH[3]}

new_patch=$((patch + 1))
new_version="${major}.${minor}.${new_patch}"

# Update VERSION file and commit locally
printf '%s\n' "$new_version" > "$VERSION_FILE"
git add "$VERSION_FILE"
git commit -m "chore: bump VERSION -> ${new_version}" --no-verify

# Inform user and abort the push so they can push the new commit themselves
cat >&2 <<EOF

VERSION was not changed in your pushed commits.
A patch bump has been committed locally: ${new_version}

Please run:
  git push

to push the bump (this hook aborted the original push to avoid race conditions).

EOF

exit 1
